LIBNAME    =@LIBNAME@

PREFIX     =@prefix@@PDLIBDIR@

INSTALL_BIN=$(PREFIX)/extra
INSTALL_DOC=$(PREFIX)/@REFERENCEPATH@$(LIBNAME)

EXT = @EXT@ 
DEFS = @DFLAGS@
IFLAGS = -I. @INCLUDES@

CC = @CC@
LD = @LD@
STRIP = @STRIP@
STRIPFLAGS= @STRIPFLAGS@

AFLAGS = 
LFLAGS = @LFLAGS@
WFLAGS =

TARNAME =  $(LIBNAME)-@ZEXY_VERSION@.tgz

.SUFFIXES: .$(EXT)

# ICCFLAGS=-march=pentiumiii -axK
PDCFLAGS = -g -O2 $(DEFS) $(IFLAGS) $(WFLAGS) $(LFLAGS) $(AFLAGS)
CFLAGS = $(DEFS) $(IFLAGS) $(WFLAGS) @CFLAGS@

LIBS = @LIBS@

include Make.source

TARGETS = $(SOURCES:.c=.o)


all: $(LIBNAME)
	cp $(LIBNAME).$(EXT) ..

$(LIBNAME): $(TARGETS)
	$(LD) $(LFLAGS) -o $(LIBNAME).$(EXT) *.o $(LIBS)
	$(STRIP) $(STRIPFLAGS) $(LIBNAME).$(EXT)

.c.o:
	$(CC) -c -o $@ $(CFLAGS) -DPD $*.c

.o.$(EXT):
	$(CC) -o $@ $(PDCFLAGS) -DPD $*.o


clean:
	-rm -f *.$(EXT) *.o 

cleaner: clean
	-rm -f *~ _* config.*

cleanest: cleaner
	-rm -f Makefile ../*.$(EXT) Make.source

distclean: cleanest newmakefile

install: install-bin install-doc install-abs

install-bin:
	-install -d $(INSTALL_BIN)
	-install -m 644 $(LIBNAME).$(EXT) $(INSTALL_BIN)

install-doc:
	-install -d $(INSTALL_DOC)
	-install -m 644 ../examples/*.pd $(INSTALL_DOC)

install-abs:
	-install -d $(INSTALL_BIN)
	-install -m 644 ../abs/*.pd $(INSTALL_BIN)

dist: all cleaner
	(cd ../..;tar czvf $(TARNAME) $(LIBNAME))

everything: clean all install distclean

newmakefile:
	echo "current:">Makefile
	echo "	./configure && make">>Makefile

make.source:
	echo "SOURCES = \\"> Make.source
	echo `ls z_*.c $(LIBNAME).c` >> Make.source
	echo >> Make.source
